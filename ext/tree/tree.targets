<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
  
    ResolveMetaProjectReferences
      Invokes msbuild on all types of project references before the well known target
  -->
  <ItemDefinitionGroup>
    <_ChildProjectReference>
      <ReferenceSource/>
      <AdditionalProperties/>
      <IncludeInResult/>
      <TargetFramework/>
      <IsPartPlatform/>
    </_ChildProjectReference>
  </ItemDefinitionGroup>
  <Target 
    Name="ResolveMetaProjectReferences"
  >
    
    <!--_ChildProjectReference-->
    <ItemGroup>
      <!--if (ChildPlatforms has value) then Platform-->
      <_ChildProjectReference 
        Condition="'@(ChildPlatforms)'!=''" 
        Include="$(ProjFile)"
      >
        <ReferenceSource>ChildPlatform</ReferenceSource>
        <AdditionalProperties>Platform=%(ChildPlatforms.Identity)</AdditionalProperties>
      </_ChildProjectReference>
      
      <!--if (LeafPlatform has value) then Platform + MetaPlatform-->
      <_ChildProjectReference 
        Condition="'$(LeafPlatform)'!=''" 
        Include="$(ProjFile)"
      >
        <ReferenceSource>LeafPlatform</ReferenceSource>
        <AdditionalProperties>Platform=$(LeafPlatform);MetaPlatform=$(MetaPlatform)</AdditionalProperties>
        <TargetFramework Condition="'$(IsMobileLibraryPlatform)'=='true'">$(TargetFramework)</TargetFramework>
      </_ChildProjectReference>
    </ItemGroup>

    <!--pre log-->
    <Message
      Text="MetaProjectReferences: @(_ChildProjectReference->Count())"
      Importance="$(ProjVerbosity)" 
    />
    <Message
      Text="  %(_ChildProjectReference.ReferenceSource): %(Identity) /t:$(BuildTarget) /+p:%(AdditionalProperties)"
      Condition="'@(_ChildProjectReference)'!=''"
      Importance="$(ProjVerbosity)"
    />

    <!--batch configurations-->
    <ItemGroup>
      <_Configurations Include="$(Configuration)" />
    </ItemGroup>

    <!--build-->
    <MSBuild
      Projects="@(_ChildProjectReference)"
      Properties="Configuration=%(_Configurations.Identity)"
      Targets="$(_Targets)"
      ContinueOnError="true"
      BuildInParallel="true"
      RemoveProperties=""
    >
      <Output ItemName="EveryResult" TaskParameter="TargetOutputs" />
    </MSBuild>

    <!--tag results-->
    <ItemGroup>
      <EveryResult Condition="true">
        <IsPartPlatform Condition="'$(IsPartPlatform)'=='true'">true</IsPartPlatform>
      </EveryResult>
    </ItemGroup>

    <!--select results-->
    <ItemGroup>
      <!--<TargetResult Include="@(EveryResult)"/>-->
      <TargetResult 
        Condition="'$(IsPartPlatform)'=='' AND '%(TargetResult.IsPartPlatform)'=='true'" 
        Remove="%(Identity)"
      />
    </ItemGroup>
    <Message
      Text="%(ReferenceSource): $(ProjName) [$(Configuration)|$(Plat)|$(MetaPlatform)] &lt;- %(TargetResult.Identity)"
      Condition="'%(Identity)'!=''"
      Importance="$(ProjVerbosity)" 
    />

    <!--ProjectReference and SelfReference -> Reference-->
    <ItemGroup>
      <ProjectReference Remove="@(ProjectReference)" />
      <IncludeInReference Include="@(EveryResult->WithMetadataValue('IncludeInReference', 'true')->'%(Name)')" >
        <HintPath>%(Identity)</HintPath>
      </IncludeInReference>
      <Reference Include="@(IncludeInReference->'%(Name)')" />
    </ItemGroup>
    <Message 
      Text="  %(ReferenceSource): Reference += %(IncludeInReference.Identity) -> %(HintPath)"
      Condition="'@(IncludeInReference)'!=''"
      Importance="$(ProjVerbosity)" 
    />
  </Target>

</Project>