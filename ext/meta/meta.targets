<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <ResolveMetaReferencesDependsOn>
      _FindBadMetaPlatform;
      _ResolveMetaProjectReferences; <!--leaf-->
      _ResolveMetaProjectReferencePaths; <!--leaf-->
      _ResolveMetaPlatform; <!--meta-->
      _ResolveMetaPlatformGroup; <!--group-->
      $(ResolveMetaReferencesDependsOn);
    </ResolveMetaReferencesDependsOn>
  </PropertyGroup>

  <!--_ResolveMetaProjectReferencePaths-->
  <Target
    Name="_ResolveMetaProjectReferencePaths"
    Condition="'$(MetaPlatformType)'=='$(LeafPlatformId)' AND '$(BuildTarget)'=='Compile'"
  >
    <PropertyGroup>
      <!--
        MS.Common.targets intellisense logic: 
          if isense engine is compiling\initializing then do not compile references 
          and instead change the build target from "compile" to simply "getTargetPath".
          Incidentally, this is also why there is no intellisense for unloaded projects.
          
          if isense is not working then run the following for all dependencies and the 
          project itself and fix any errors:
          
            msbuild /v:m /t:compile /p:isinvs=true /p:platform=[platform] [/p:verbosity=high]
      -->
      <MetaBuildTarget>GetTargetPath</MetaBuildTarget>
    </PropertyGroup>
  </Target>

  <!--_ResolveMetaProjectReferences-->
  <Target 
    Name="_ResolveMetaProjectReferences"
    Condition="'$(MetaPlatformType)'=='$(LeafPlatformId)'"
  >
    <Error
      Condition="!$([System.Text.RegularExpressions.Regex]::IsMatch('$(SupportedPlatforms.ToLower())', '(^|;)\s*$(MetaPlatform.ToLower())\s*($|;)'))"
      Text="Platform '$(MetaPlatform)' is not supported by '$(MetaProject)' project type."
    />
    <Error
      Condition="'$(BuildTarget)'=='Compile' AND '$(IsInVS)'!='true'"
      Text="Platform 'Compile' is only supported when building in VS during intellisesne loading."
    />

    <!--MetaReference-->
    <ItemGroup>

      <!--ProjectReference -> MetaReference-->
      <MetaReference
        Condition="'@(ProjectReference)'!=''"
        Include="@(ProjectReference->'$(ProjDir)%(Identity)')"
      >
        <ReferenceSource>ProjectReference</ReferenceSource>
        <Platform>$(LibraryPlatform)</Platform>
        <AdditionalProperties>$(ClearRecursiveFrame)Platform=$(LibraryPlatform)</AdditionalProperties>
        <Name>%(Name)</Name>
        <IncludeInReferences>true</IncludeInReferences>
      </MetaReference>
      <ProjectReference Remove="@(ProjectReference)" />

      <!--SelfReference -> MetaReference-->
      <MetaReference
        Condition="'@(SelfReference)'!=''" 
        Include="$(ProjFile)" 
      >
        <ReferenceSource>SelfReference</ReferenceSource>
        <Platform>%(SelfReference.Identity)</Platform>
        <AdditionalProperties>$(ClearRecursiveFrame)Platform=%(Identity)</AdditionalProperties>
        <Name>$(AssemblyName)</Name>
        <IncludeInReferences>true</IncludeInReferences>
      </MetaReference>
    </ItemGroup>
  </Target>

  <!--_ResolveMetaPlatform-->
  <Target
    Name="_ResolveMetaPlatform"
    Condition="'$(MetaPlatformType)'=='$(MetaPlatformId)'"
  >
    <ItemGroup>
      <MetaReference Include="$(ProjFile)">
        <ReferenceSource>LeafPlatform</ReferenceSource>
        <Platform>$(LeafPlatform)</Platform>
        <AdditionalProperties>$(KeepRecursiveFrame)Platform=$(LeafPlatform);_MetaPlatform=$(MetaPlatform)</AdditionalProperties>
        <TargetFramework>$(TargetFramework)</TargetFramework>
      </MetaReference>
    </ItemGroup>
  </Target>

  <!--_ResolveMetaPlatformGroup-->
  <Target
    Name="_ResolveMetaPlatformGroup"
    Condition="'$(MetaPlatformType)'=='$(GroupPlatformId)'"
  >
    <ItemGroup>
      <MetaReference Include="$(ProjFile)">
        <ReferenceSource>GroupPlatform</ReferenceSource>
        <Platform>%(ChildMetaPlatforms.Identity)</Platform>
        <AdditionalProperties>$(KeepRecursiveFrame)Platform=%(Identity)</AdditionalProperties>
      </MetaReference>
    </ItemGroup>
  </Target>

  <!--_FindBadMetaPlatform-->
  <Target
    Name="_FindBadMetaPlatform"
    Condition="'$(MetaPlatformType)'==''"
  >
    <Error
      Condition="'$(LeafPlatform)'==''"
      Text="Platform '$(Plat)' is unrecognized."
    />
  </Target>
  
</Project>