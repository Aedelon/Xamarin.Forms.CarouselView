<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    
    DryRun
  -->
  <PropertyGroup>
    <DryRunDependsOn />
  </PropertyGroup>
  <Target
    Name="DryRun"
    DependsOnTargets="$(DryRunDependsOn)"
    Returns="@(TargetResult)"
  >
    <ItemGroup>
      <TargetResult Include="(path to $(ProjName) result [$(Configuration)|$(Plat)|$(MetaPlatform)])" />
    </ItemGroup>
  </Target>

  <!--ResolveMetaReferences-->
  <Target
    Name="ResolveMetaReferences"
    BeforeTargets="Proxy"
    DependsOnTargets="_DumpFrame"
    Outputs="%(Configuration.Identity)"
  >
    <PropertyGroup>
      <MetaBuildTarget Condition="'$(MetaBuildTarget)'==''">$(BuildTarget)</MetaBuildTarget>
    </PropertyGroup>
    
    <!--input MetaReferences-->
    <Message
      Text="$(ProjName) [$(Configuration)|$(Plat)|$(MetaPlatform)] ->"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(MetaVerbosity)"
    />
    <Message
      Text="  %(MetaReference.ReferenceSource): %(Identity) /t:$(MetaBuildTarget) /+p:%(AdditionalProperties)"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(MetaVerbosity)"
    />

    <!--build MetaReferences-->
    <MSBuild
      Projects="@(MetaReference)"
      Targets="$(MetaBuildTarget)"
      Properties="Configuration=%(Configuration.Identity)"
      ContinueOnError="true"
      BuildInParallel="true"
    >
      <Output ItemName="TargetResult" TaskParameter="TargetOutputs" />
    </MSBuild>

    <!--refresh MetaReferences-->
    <ItemGroup>
      <MetaReference Remove="@(MetaReference)"/>
      <MetaReference Include="@(TargetResult)"/>
    </ItemGroup>

    <!--output MetaReferences-->
    <Message
      Text="$(ProjName) [$(Configuration)|$(Plat)|$(MetaPlatform)] &lt;-"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(MetaVerbosity)"
    />
    <Message
      Text="  %(ReferenceSource): %(MetaReference.Identity)"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(MetaVerbosity)"
    />
  </Target>

  <!--ResolveMetaProjectReferences-->
  <Target 
    Name="ResolveMetaProjectReferences"
    BeforeTargets="ResolveMetaReferences"
    Condition="'$(PlatformType)'=='$(LeafPlatformId)'"
  >
    <Error
      Condition="!$([System.Text.RegularExpressions.Regex]::IsMatch('$(SupportedPlatforms.ToLower())', '(^|;)\s*$(MetaPlatform.ToLower())\s*($|;)'))"
      Text="Platform '$(MetaPlatform)' is not supported by '$(MetaProject)' project type."
    />
    <Error
      Condition="'$(BuildTarget)'=='Compile' AND '$(IsInVS)'!='true'"
      Text="Platform 'Compile' is only supported when building in VS during intellisesne loading."
    />
    
    <!--MetaReference-->
    <ItemGroup>

      <!--ProjectReference -> MetaReference-->
      <MetaReference
        Condition="'@(ProjectReference)'!=''"
        Include="@(ProjectReference->'$(ProjDir)%(Identity)')"
      >
        <ReferenceSource>ProjectReference</ReferenceSource>
        <AdditionalProperties>$(ClearRecursiveFrame);Platform=$(LibraryPlatform)</AdditionalProperties>
        <Name>%(Name)</Name>
        <IsPartPlatform Condition="'$(IsPartPlatform)'=='true'">true</IsPartPlatform>
      </MetaReference>
      <ProjectReference Remove="@(ProjectReference)" />

      <!--SelfReference -> MetaReference-->
      <MetaReference
        Condition="'@(SelfReference)'!=''" 
        Include="$(ProjFile)" 
      >
        <ReferenceSource>SelfReference</ReferenceSource>
        <AdditionalProperties>$(ClearRecursiveFrame);Platform=%(SelfReference.Identity)</AdditionalProperties>
        <Name>$(AssemblyName)</Name>
        <IsPartPlatform Condition="'$(IsPartPlatform)'=='true'">true</IsPartPlatform>
      </MetaReference>
      <SelfReference Remove="@(SelfReference)" />
    </ItemGroup>

    <!--MS.Common.targets intellisense logic: 
          if intellisense engine is compiling\initializing then do not compile references 
          and instead change the build target from "compile" to simply "getTargetPath".
          Incidentally, this is also why there is no intellisense for unloaded projects.
    -->
    <PropertyGroup>
      <MetaBuildTarget Condition="'$(BuildTarget)'=='Compile'">GetTargetPath</MetaBuildTarget>
    </PropertyGroup>
  </Target>

  <!--RemovePart-->
  <Target
    Name="RemovePart"
    AfterTargets="ResolveMetaReferences"
    Condition="'$(PlatformType)'=='$(LeafPlatformId)'"
  >
    <!--select results-->
    <!--<ItemGroup>
      <TargetResult 
        Condition="'$(IsPartPlatform)'=='' AND '%(TargetResult.IsPartPlatform)'=='true'" 
        Remove="%(Identity)"
      />
    </ItemGroup>-->
  </Target>

  <!--MetaProjectReferencesToReferences-->
  <Target
    Name="MetaProjectReferencesToReferences"
    AfterTargets="ResolveMetaReferences"
    Condition="'$(PlatformType)'=='$(LeafPlatformId)'"
  >
    <!--select results-->
    <!--<ItemGroup>
      <TargetResult 
        Condition="'$(IsPartPlatform)'=='' AND '%(TargetResult.IsPartPlatform)'=='true'" 
        Remove="%(Identity)"
      />
    </ItemGroup>-->

    <!--MetaReference -> Reference-->
    <ItemGroup>
      <Reference Include="@(MetaReference->'%(Name)')" >
        <HintPath>%(Identity)</HintPath>
      </Reference>
    </ItemGroup>
    <Message 
      Text="$(ProjName) [$(Configuration)|$(Plat)|$(MetaPlatform)]: Reference += %(Identity)"
      Condition="@(MetaReference->Count()) > 0"
      Importance="$(MetaVerbosity)" 
    />
  </Target>

  <!--BuildMetaPlatform-->
  <Target
    Name="BuildMetaPlatform"
    BeforeTargets="ResolveMetaReferences"
    Condition="'$(PlatformType)'=='$(MetaPlatformId)'"
  >
    <ItemGroup>
      <MetaReference Include="$(ProjFile)">
        <ReferenceSource>LeafPlatform</ReferenceSource>
        <AdditionalProperties>Platform=$(LeafPlatform);_MetaPlatform=$(MetaPlatform)</AdditionalProperties>
        <TargetFramework Condition="'$(IsMobileLibraryPlatform)'=='true'">$(TargetFramework)</TargetFramework>
      </MetaReference>
    </ItemGroup>
  </Target>

  <!--BuildMetaPlatformGroup-->
  <Target
    Name="BuildMetaPlatformGroup"
    BeforeTargets="ResolveMetaReferences"
    Condition="'$(PlatformType)'=='$(GroupPlatformId)'"
  >
    <ItemGroup>
      <MetaReference Include="$(ProjFile)">
        <ReferenceSource>GroupPlatform</ReferenceSource>
        <AdditionalProperties>Platform=%(ChildPlatforms.Identity)</AdditionalProperties>
      </MetaReference>
    </ItemGroup>
  </Target>

  <!--BadMetaPlatform-->
  <Target
    Name="BadMetaPlatform"
    BeforeTargets="ResolveMetaReferences"
    Condition="'$(PlatformType)'==''"
  >
    <Error
      Condition="'$(LeafPlatform)'==''"
      Text="Platform '$(Plat)' is unrecognized."
    />
  </Target>


  <!--
  
    _DumpFrame
  -->
  <Target
    Name="_DumpFrame"
    Condition="'$(BuildTarget)'=='DryRun' OR '$(Verbosity)'=='high'"
  >
    <PropertyGroup>
      <Tag>BUILD</Tag>
      <Tag Condition="'$(IsLeafPlatform)'!='true'">RECURSE</Tag>
    </PropertyGroup>

    <ItemGroup>
      <_Property Include="BuildTarget" />
      <_Property Include="ProjFile" />
      <_Property Include="IsLeafPlatform" />
      <_Property Include="IsMetaPlatform" />
      <_Property Include="IsMobileLibraryPlatform" />
      <_Property Include="IsMobileAppPlatform" />
      <_Property Include="IsPartPlatform" />
      <_Property Include="IsMobileAppProject" />
      <_Property Include="IsMobileLibraryProject" />
      <_Property Include="IsMobileTestProject" />
      <_Property Include="IsDesktopLibraryProject" />
      <_Property Include="LeafPlatform" />
      <_Property Include="MobilePlatform" />
      <_Property Include="MobileSubPlatform" />
      <_Property Include="LibraryPlatform" />
      <_Property Include="DefineConstants" />
      <_Property Include="TargetProject" />
      <_Property Include="TargetsFile" />
      <_Property Include="CommonTargetsPath" />
      <_Property Include="CSharpCoreTargetsPath" />
      <_Property Include="BuildingInsideVisualStudio" />
    </ItemGroup>
    <ItemGroup Condition="'$(IsLeafPlatform)'=='true'">
      <_Property Include="OutDirAbsolute" />
      <_Property Include="IntermediateOutputPathAbsolute" />
      <_Property Include="TargetsFile" />
    </ItemGroup>

    <Message 
      Importance="high" 
      Text="$(Tag) [$(Configuration)|$(Plat)|$(MetaPlatform)]: $(AssemblyName) -> { @(ChildPlatforms)$(LeafPlatform) }"
    />
    <Message
      Importance="high"
      Text="  %(_Property.Identity) -> $(%(Identity))"
      Condition="'$(%(Identity))'!=''"
    />
    <Message
      Importance="high"
      Text="    ProjectReference: %(ProjectReference.Identity) -> %(FullPath)"
      Condition="'@(ProjectReference)'!=''"
    />
  </Target>
  
</Project>