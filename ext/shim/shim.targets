<?xml version="1.0" encoding="utf-8"?>
<Project 
  ToolsVersion="12.0" 
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <!--Proxy-->
  <Target Name="Proxy">
    
    <!--self dispatch (to enable logging)-->
    <MSBuild
      Targets="_ExecDispatch"
      Projects="$(ProjFile)"
      Properties="BuildTarget=$(BuildTarget)"
      Condition="$(IsShimStateInit)"
    />

    <!--before shim target-->
    <MSBuild
      Projects="$(ShimBeforeProject)"
      Targets="$(ShimBeforeTarget)"
      Condition="$(IsShimStateSelf)"
    />
    
    <!--inject shim target(s)-->
    <ItemGroup>
      <_ShimTarget Include="$(ShimTarget)" />
    </ItemGroup>
    <MSBuild
      Targets="_ExecDispatch"
      Projects="$(ProjFile)"
      Properties="BuildTarget=%(_ShimTarget.Identity)"
      Condition="
        $(IsShimStateSelf) AND 
        '$(ShimTarget)'!='' AND
        !@(_ShimTarget->AnyHaveMetadataValue('Identity','$(BuildTarget)'))
      "
    />

    <CreateItem
      Include="@(ProjFile)"
      AdditionalMetadata="AdditionalProperties=Configuration=%(Configuration.Identity)"
    >
      <Output ItemName="ProjFileConfig" TaskParameter="Include"/>
    </CreateItem>

    <!--dispatch build target-->
    <MSBuild
      Targets="_ExecDispatch"
      Projects="@(ProjFileConfig)"
      Properties="BuildTarget=$(BuildTarget);IsConfigBuild=true"
      Condition="$(IsShimStateSelf)"
    />

    <!--after shim target-->
    <MSBuild
      Projects="$(ShimAfterProject)"
      Targets="$(ShimAfterTarget)"
      Condition="$(IsShimStateSelf)"
    />

  </Target>

  <!--DumpProjects-->
  <Target Name="DumpProjects">
    <Message Importance="$(Verbosity)" Text="ShimProjectFiles:" />
    <Message Importance="$(Verbosity)" Text="  %(ShimProjectFiles.FullPath)" />
  </Target>

  <!--_ExecDispatch-->
  <Target Name="_ExecDispatch">
    <PropertyGroup>
      <_BuildId>$(BuildTarget)</_BuildId>
      <_BuildId Condition="'$(IsConfigBuild)'=='true'">$(_BuildId).$(Configuration)</_BuildId>
    </PropertyGroup>
    <Message Importance="high" Text="$(BuildName) ($(_BuildId)) -> $(BuildLogFile)" />
    <Message Importance="$(Verbosity)" Text="Command:" />
    <Message Importance="$(Verbosity)" Text="  %(BuildCommand.Identity)" />

    <PropertyGroup>
      <BuildCommand>@(BuildCommand, ' ')</BuildCommand>
    </PropertyGroup>

    <MakeDir Directories="$(BuildLogDir)"/>
    <Exec 
      Command="$(BuildCommand)" 
      WorkingDirectory="$(MSBuildStartupDirectory)"
    />
  </Target>

  <!--_Dispatch-->
  <Target Name="_Dispatch">

    <MSBuild
      Projects="@(DispatchProjectFiles)"
      Targets="$(BuildTarget)"
      ContinueOnError="true"
      BuildInParallel="true"
      RemoveProperties=""
    />
  </Target>

</Project>