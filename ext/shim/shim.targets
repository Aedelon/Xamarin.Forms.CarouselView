<?xml version="1.0" encoding="utf-8"?>
<Project 
  ToolsVersion="12.0" 
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <!--InitShim-->
  <Target 
    Name="InitShim"
    BeforeTargets="Proxy"
    Condition="'$(ShimState)'=='$(ShimStateInitId)'"
  >
    <!--if the BuildTarget is the ShimTarget (e.g. /t:NugetRestore) then no need to shim out-of-proc-->
    <PropertyGroup  
      Condition="
        '$(BuildTarget)'=='$(ShimTarget)' OR 
        '$(BuildTarget)'=='' OR
        '$(ShimTarget)'==''
      ">
      <_Properties>ShimInProcess=true</_Properties>
      <ExecDispatch>_Dispatch</ExecDispatch>
    </PropertyGroup>
    
    <!--self dispatch (to enable logging)-->
    <MSBuild
      Targets="$(ExecDispatch)"
      Projects="$(ProjFile)"
      Properties="ShimState=$(NextShimState);BuildTarget=$(BuildTarget);$(_Properties)"
    >
      <Output ItemName="TargetResult" TaskParameter="TargetOutputs"/>
    </MSBuild>
  </Target>

  <!--PrePostShim-->
  <Target 
    Name="PrePostShim"
    BeforeTargets="Proxy"
    Condition="'$(ShimState)'=='$(ShimStatePrePostId)'"
  >

    <!--before shim target-->
    <MSBuild
      Projects="$(ShimBeforeProject)"
      Targets="$(ShimBeforeTarget)"
    />

    <!--self dispatch-->
    <MSBuild
      Targets="$(BuildTarget)"
      Projects="$(ProjFile)"
      Properties="ShimState=$(NextShimState)"
    >
      <Output ItemName="TargetResult" TaskParameter="TargetOutputs"/>
    </MSBuild>

    <!--after shim target-->
    <MSBuild
      Projects="$(ShimAfterProject)"
      Targets="$(ShimAfterTarget)"
    />
  </Target>
  
  <!--Shim-->
  <Target 
    Name="Shim"
    Condition="'$(ShimState)'=='$(ShimStateProjectsId)'"
    BeforeTargets="Proxy"
  >

    <!--shim references-->
    <MSBuild
      Targets="$(BuildTarget)"
      Projects="$(ProjFile)"
      Properties="ShimDir=%(ShimReference.Identity)"
      Condition="@(ShimReference->Count()) > 0"
    />

    <!--inject shim target(s)-->
    <MSBuild
      Targets="$(ExecDispatch)"
      Projects="$(ProjFile)"
      Properties="ShimState=$(NextShimState);BuildTarget=$(ShimTarget);Properties=$(ShimProperties)"
      Condition="'$(ShimTarget)'!=''"
    />
  </Target>

  <!--BuildProjects-->
  <Target
    Name="BuildProjects"
    DependsOnTargets="Shim"
    Condition="'$(ShimState)'=='$(ShimStateProjectsId)' AND '$(ShimName)'!=''"
    BeforeTargets="Proxy"
  >
    <!--expand configurations-->
    <CreateItem
      Include="@(ProjFile)"
      AdditionalMetadata="AdditionalProperties=Configuration=%(Configuration.Identity)"
    >
      <Output ItemName="ProjFileWithConfig" TaskParameter="Include"/>
    </CreateItem>
    
    <!--dispatch build target-->
    <MSBuild
      Targets="$(ExecDispatch)"
      Projects="@(ProjFileWithConfig)"
      Properties="ShimState=$(NextShimState);BuildTarget=$(BuildTarget);Properties=$(ShimmedProperties)"
      Condition="'$(ShimTarget)'!='$(BuildTarget)'"
    />
  </Target>

  <!--DumpProjects-->
  <Target Name="DumpProjects">
    <Message Importance="$(ShimVerbosity)" Text="ShimDir: $(ShimDir)" />
    <Message Importance="$(ShimVerbosity)" Text="ShimInclude: $(ShimInclude)" />
    <Message Importance="$(ShimVerbosity)" Text="ShimExclude: $(ShimExclude)" />
    <Message Importance="$(ShimVerbosity)" Text="ShimProjectFiles:" />
    <Message Importance="$(ShimVerbosity)" Text="  %(ShimProjectFiles.FullPath)" Condition="'@(ShimProjectFiles)'!=''" />
    <Message Importance="$(ShimVerbosity)" Text="ShimRefernces:" />
    <Message Importance="$(ShimVerbosity)" Text="  %(ShimReference.FullPath)" Condition="'@(ShimReference)'!=''" />
  </Target>

  <!--_ExecDispatch-->
  <Target Name="_ExecDispatch">

    <!--BuildCommand += MakeLogDir-->
    <MSBuild 
      Projects="$(ProjFile)"
      Targets="MakeLogDir"
    >
      <Output ItemName="BuildCommand" TaskParameter="TargetOutputs" />
    </MSBuild>
    <Message Importance="$(ShimVerbosity)" Text="Command: $(ShimDir)" />
    <Message Importance="$(ShimVerbosity)" Text="  %(BuildCommand.Identity)" />

    <!--exec msbuild.exe-->
    <PropertyGroup>
      <BuildCommand>@(BuildCommand, ' ')</BuildCommand>
    </PropertyGroup>
    <Exec 
      Command="$(BuildCommand)" 
      WorkingDirectory="$(MSBuildStartupDirectory)"
    />
  </Target>

  <!--_Dispatch-->
  <Target Name="_Dispatch">
    <MSBuild
      Projects="@(DispatchProjectFiles)"
      Targets="$(BuildTarget)"
      ContinueOnError="true"
      BuildInParallel="true"
      Properties="$(Properties)"
      RemoveProperties=""
    />
  </Target>

</Project>