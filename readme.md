# Build Environment
Xamarin.Forms.Carousel repo contains an alpha Xamarin Forms build enviroment. Similar to other .NET foundation repos (e.g. coreclr) everything starts in a shell. From there you'll need to build (or at least restore nuget packages) before opening the solution. The next generation build environment is being developed in the xfproj branch. For now the following commands should get you off the ground:

## Opening Solution

1. open cmd.exe using `\env\env.lnk`
2. type `restore` to restore nuget files
3. type `\src\Xamarin.Forms.CarouselView.sln`

## Building Everything

1. open `cmd.exe` \env\env.lnk
2. type `build` to build both debug and release package
3. package will be at `\bin\bld\release\carouselView\nuget\`

# Directories
The following directories are well known to the build system and shell. Navigate to most well known directories by typing its name into the shell (just try type the name to see if there is an alias). Type `r` to navigate to the root directory.

## Enlistment
The following well-known directories are under source control. Build artifacts are placed outside of these directories which allows for a vastly simplified \.gitignore file.
````
▌ root of enlistement
├──▌ src - filescontribute to build output
├──▌ ext - files that extend msbuild
├──▌ env - files that initialize the shell; misc .bat files
└──▌ doc - files that document the system
````

## Artifacts
The following well-known directories are under generated by the build and are not under source control.
````
▌ root of enlistement
├──▌ bld - output of build
│  ├──▌ bin - resultant binaries of build
│  └──▌ obj - temporary build files
├──▌ dls - downloads; cache of files needed before going offline
│  ├──▌ packages - nuget packages
│  └──▌ tools - misc tools; nuget.exe
└──▌ drp - archive of builds kicked off from root
````

# Sub-Directories
Sub-directories of well-known directories. They generally do not have shell aliases but do have structure specific to their function.

## \bld\
Build output generated from a sub-directory in `src` is placed in the same sub-directory in `bin` (or `obj`). For example, build output from building `src\carouselView\lib\CarouselView.csproj` is placed in `bld\bin\carouselView\lib` and `bld\obj\carouselView\lib`. 

If projects are built using the shim (a project which searches for and then builds .csproj files after, among other things, configuring logging. It lives at ext\shim\shim.proj which and is typically invoked through its alias `build`, `rbuild`, `dbuild`) then log files of all verbosities (summary, normal, detailed, and diag) and severities (warning, and error) are also created. If the shim is invoked from the root then it is assumed the build will be published (copied) to `drp\number\$(BuildNumber)` and a build number is generated and recorded along with the current source control identifying information (revision, branch, url, etc).
````
▌ bin
└──▌ bld
│  ├─ BuildInfo.Build.Number - computed by adding one to the last sub-directory of drp\number\
│  ├─ BuildInfo.Enlistment.revision - computed by consulting source control (git)
│  ├─ BuildInfo.Enlistment.status - capture the state of the enlistment; publication fails if dirty
│  ├─ Shim.Build.*.log - log of shim launching other build processes
│  ├─ Core.NugetRestore.*.log - log of nuget restore which happens before launching core build
│  └──▌ debug or release
│     ├─ Core.Build.*.log - compiler errors will appear in here
│     └──▌ [relative directory from src]
└──▌ obj
   └──▌ debug or release
      └──▌ [relative directory from src]
         └ BuildInfo.cs - generated by shim, replaces universally included src\BuildInfo.cs during build
````

## \drp\
````
▌ drp
├──▌ number - archived builds by build number
└──▌ revision - archived builds by source control revision
````

# Shell

## Shell Commands

### Building
build - build both release and debug
rbuild - build release
dbuild - build debug

# History

The Xamarin.Forms library build environment addresses challenges encountered while developing CarouselView with the goal of simplifying the creation of Xamarin.Forms libraries in general. 

The number of binaries an app needs to reference to use a library is reduced from 3 (portable, platform, and shim [to support the linker]) to 1. This is achived by compiling the portable (and shim) logic into the platform library. This allows a `RenderWithAttribute` applied to the portable renderer to directly reference the platform renderer ([see here][2]). This obviates the need for the shim library and dodges a large class of potential linker issues. A compiler error is still generated if the platform logic references internal portable logic. Under the hood, this is achived by kicking off additional compilations of the project. The code can check for the the `COMPOSITE` compilation symbol to know what type of compilation is occuring.

The number of C# projects required for building a library is been reduced from 7 (e.g. a project for Portable, Android, iOS [Classic & Unified], and Windows [tablet, phone, uap] to 1. This is achived (with some effort!) by "merging" the 7 project files into a single project file with each merged project file becoming its own platform. So, for example, the Android CarouselView library can be built like this:

    src\carouselView\lib> msbuild myLibrary.csproj /p:platform=monodroid

To build the iOS version substitute `monodroid` with `monotouch`. To build all platforms at once use the platform `mobile`. To peek under the hood, pass `/t:dryRun` to dump the tree traversal used to build these "meta-platforms".

Tooling support for the unified project is as best as can be done without creating a VSIP project system. Intellisense, debugging, and reflecting over some the project settings can be made to work (e.g. when Properties is opened the compilation symbols will be correct) however edits to the unified project via the UI are generally not supported (e.g. adding a new file for a specific platform via the UI will require editing the project file by hand and moving the Compile reference under the [ItemGroup][3] which the correct Condition for the platform in which it's expected to be compiled). Again, to support UI operations a Xamarin.Forms VSIP plugin will need to be developed.

The project contains a folder for each platform the contents of which will only be compiled (and have correct intellisense) when the corrisponding platform is selected. Debugging is gently hacked in; Ideally, to debug the android application select the CarouselView.App.Android csproj.

__ 


[1]: https://github.com/xamarin/Xamarin.Forms.Carousel/blob/master/env/env.lnk
[2]: https://github.com/xamarin/Xamarin.Forms.CarouselView/blob/xfproj/src/carouselView/lib/Portable/CarouselView.cs#L10
[3]: https://github.com/xamarin/Xamarin.Forms.CarouselView/blob/xfproj/src/carouselView/lib/CarouselView.csproj#L122
